I"â<h1 id="leb128æ ¼å¼ç®€ä»‹">LEB128æ ¼å¼ç®€ä»‹</h1>

<h2 id="1-å†™åœ¨å‰é¢">1. å†™åœ¨å‰é¢:</h2>
<p>LEB128å³â€Little-Endian Base 128â€ï¼ŒåŸºäº128çš„å°å°ç¬¬å®‰åºç¼–ç æ ¼å¼ï¼Œæ˜¯å¯¹ä»»æ„æœ‰ç¬¦å·æˆ–è€…æ— ç¬¦å·æ•´å‹æ•°çš„å¯å˜é•¿åº¦çš„ç¼–ç ã€‚
 LEB128( Little Endian Base 128 )  æ˜¯ä¸€ä¸ªå˜é•¿çš„æ•°æ®æ ¼å¼ï¼ˆæ‰€å çš„å­—èŠ‚æ•°å¯å˜ï¼‰å…¶åˆ†ä¸º unsinged LEB128 å’Œ signed LEB128</p>

<p>åœ¨é˜…è¯»dyldæºç çš„è¿‡ç¨‹ä¸­, å¥½å¤šåœ°æ–¹éƒ½ä¼šç”¨åˆ° <code class="language-plaintext highlighter-rouge">read_uleb128</code> å‡½æ•°:</p>

<p>è¯¥æ–¹æ³•çš„ä½œç”¨, å°±æ˜¯è§£æå†…å­˜ä¸­çš„LEB128æ•°æ®</p>

<h2 id="2-leb128æ•°æ®çš„æ„æˆ">2. LEB128æ•°æ®çš„æ„æˆ:</h2>
<p>æ•°æ®æ ¼å¼:
<img src="/images/2022/dyld/LEB128/leb128.png" alt="LEB128" /></p>

<p>è¦ç‚¹:</p>
<ul>
  <li>LEB128æ•°æ®è½¬æ¢æˆ2è¿›åˆ¶æ•°æ®å, æ¯ä¸ªå­—èŠ‚åªæœ‰bit0 â€“ bit6 ä½æ˜¯æœ‰æ•ˆä½</li>
  <li>LEB128æ•°æ®æ¯ä¸ªè‡ªå·±çš„æœ€é«˜ä½ä¸æ˜¯æœ‰æ•ˆæ•°å­—, åªèƒ½æ˜¯0 æˆ– 1</li>
  <li>LEB128æ•°æ®çš„æœ€é«˜ä½å­—èŠ‚çš„bit 7 æ˜¯0, å…¶ä»–ä½å­—èŠ‚çš„bit 7 å‡ä¸º 1</li>
</ul>

<p>å°†leb128ç¼–ç çš„æ•°å­—è½¬æ¢ä¸ºå¯è¯»æ•°å­—çš„è§„åˆ™æ˜¯ï¼šé™¤å»æ¯ä¸ªå­—èŠ‚çš„bit7ï¼Œå°†æ¯ä¸ªå­—èŠ‚å‰©ä½™çš„7ä¸ªbitsæ‹¼æ¥åœ¨ä¸€èµ·ï¼Œå³ä¸ºæ•°å­—ã€‚</p>

<h2 id="3-leb128-æ— ç¬¦å·è¯»å–">3. LEB128 æ— ç¬¦å·è¯»å–</h2>
<p>LEB128çš„wikiä¸Šæ¯”è¾ƒæ¸…æ¥šçš„è¡¨ç¤ºäº†ä¸€ä¸ªå¦‚ä½•æŠŠä¸€ä¸ªæ— ç¬¦å·çš„æ•´å‹æ•°å‹ç¼©ä½3ä¸ªbytesçš„LEB128æ ¼å¼ã€‚</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
10011000011101100101 æ˜¯ 624485çš„2è¿›åˆ¶è¡¨ç¤º

010011000011101100101 æŠŠ2è¿›åˆ¶çš„è¡¨ç¤ºçš„bitæ‰©å±•ä¸ºèƒ½è¢«7æ•´é™¤(ä¸è¶³çš„åŠ 0)

0100110 0001110 1100101 å†ä»¥7-bitä¸ºä¸€ç»„è¿›è¡Œåˆ†ç»„

00100110 10001110 11100101 æŠŠç¬¬ä¸€ç»„+0æ‰©å±•ä¸º8bitï¼Œè€Œå…¶ä½™çš„éƒ½+1æ‰©å±•ä¸º8bit
</code></pre></div></div>
<p>dyldæºä»£ç ä¸­çš„è¯»å–å‡½æ•°:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>uintptr_t ImageLoader::read_uleb128(const uint8_t*&amp; p, const uint8_t* end)
{
	uint64_t result = 0;
	int		 bit = 0;
	do {
		if (p == end)
			dyld::throwf("malformed uleb128");
// è·å–ä½ä¸ƒä½æ•°æ® å³ &amp; 0111 1111
		uint64_t slice = *p &amp; 0x7f;
// å¦‚æœç§»ä½å¤§äº64, è¯´æ˜å·²è¶…å‡ºarm64 æ¶æ„çš„å–å€¼èŒƒå›´
		if (bit &gt; 63)
			dyld::throwf("uleb128 too big for uint64, bit=%d, result=0x%0llX", bit, result);
		else {
			result |= (slice &lt;&lt; bit);// è®°å½•å½“å‰æ•°æ®
			bit += 7; // å‘é«˜ä½ç§»åŠ¨ä¸ƒä½(å³è¾¹è¡¥7ä¸ª000)
		}
	} while (*p++ &amp; 0x80);// å¦‚æœå­—èŠ‚çš„bit7ä¸ºæ˜¯1( 0x80 -&gt; 1000 0000), è¯´æ˜è¿˜æ²¡æœ‰å–åˆ°æœ€é«˜ä½
	return result;
}
</code></pre></div></div>
<h2 id="4-leb128-æœ‰ç¬¦å·è¯»å–">4. LEB128 æœ‰ç¬¦å·è¯»å–</h2>
<p>è€Œå¯¹äºæœ‰ç¬¦å·çš„è½¬æ¢åªæœ‰æ–‡å­—æè¿°ï¼Œä¸‹é¢æˆ‘å¥—ç”¨æ— ç¬¦å·çš„æ ¼å¼ï¼Œæè¿°ä¸€ä¸‹æœ‰ç¬¦å·çš„å‹ç¼©</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>-624485çš„2è¡¥ç è®¡ç®—è¿‡ç¨‹:
åŸç : 1 10011000011101100101 
åç : 1 01100111100010011010 
è¡¥ç : 1 01100111100010011011  

01100111100010011011 -624485çš„2è¿›åˆ¶è¡¨ç¤º(è¡¥ç )

001100111100010011011 æŠŠ2è¿›åˆ¶çš„è¡¨ç¤ºæ‰©å±•ä¸ºèƒ½è¢«7æ•´é™¤

0011001 1110001 0011011 å†ä»¥7-bitä¸ºä¸€ç»„è¿›è¡Œåˆ†ç»„

01011001 11110001 10011011 æŠŠç¬¬ä¸€ç»„+0æ‰©å±•ä¸º8bitï¼Œè€Œå…¶ä½™çš„éƒ½æ ¹æ®åŸæ•´å½¢æ•°çš„ç¬¦å·ä½æ¥æ‰©å±•ä¸º8bit(æ‰€ä»¥è¿™é‡Œæœ€åä¸¤ä¸ª7bitç»„éƒ½æ˜¯+1æ¥æ‰©å±•çš„)

0x59 0xf1 0x9b ç»“æœè¡¨ç¤ºä½16è¿›åˆ¶

0x9b 0xf1 0x59 æœ€ç»ˆåœ¨å†…å­˜ä¸­çš„è¡¨ç¤º
</code></pre></div></div>

<p>è¯»å–å‡½æ•°:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>intptr_t ImageLoader::read_sleb128(const uint8_t*&amp; p, const uint8_t* end)
{
	int64_t result = 0;
	int bit = 0;
	uint8_t byte;
	do {
		if (p == end)
			throw "malformed sleb128";
			// byte å…ˆæŒ‡å‘æœ€ä½å­—èŠ‚
		byte = *p++;
		// byte è·å–ä½ä¸ƒä½æ•°æ®, å¹¶åšç›¸åº”ç§»ä½
		result |= (((int64_t)(byte &amp; 0x7f)) &lt;&lt; bit);
		bit += 7; // ç§»å‘æ›´é«˜å­—èŠ‚
	} while (byte &amp; 0x80); // å¦‚æœå­—èŠ‚çš„bit7ä¸ºæ˜¯1( 0x80 -&gt; 1000 0000), è¯´æ˜è¿˜æ²¡æœ‰å–åˆ°æœ€é«˜ä½
	// sign extend negative numbers
	if ( (byte &amp; 0x40) != 0 ) 
		result |= (-1LL) &lt;&lt; bit; // è¡¥ä¸Šç¬¦å·ä½
	return result;
}
</code></pre></div></div>
<h2 id="5-ä¸¾ä¾‹">5. ä¸¾ä¾‹</h2>
<p>dyld åŠ è½½åŠ¨æ€åº“è¿‡ç¨‹ä¸­, è§£æ <code class="language-plaintext highlighter-rouge">Dynamic Loader Info</code> -&gt; <code class="language-plaintext highlighter-rouge">Lazy BIngding Info</code> -&gt; <code class="language-plaintext highlighter-rouge">Opcodes</code> æ—¶, ä¼šç»å¸¸ç”¨åˆ°LEB128:
<img src="/images/2022/dyld/LEB128/example.jpg" alt="LEB128" />
ç”±äºiOS é‡‡ç”¨å°æ®µæ¨¡å¼ 0x880B åœ¨å†…å­˜ä¸­çš„, çœŸæ­£çš„æ•°æ®æ ¼å¼æ˜¯0x0B88, 2è¿›åˆ¶è¡¨ç¤º:
00001011 10001000
æŒ‰ç…§æ— ç¬¦å·è½¬æ¢è§„åˆ™:</p>
<ul>
  <li>ä½å­—èŠ‚å»æ‰æœ€é«˜ä½1, å³ 0001000</li>
  <li>é«˜å­—èŠ‚å»æ‰æœ€é«˜ä½0, å³ 0001011</li>
  <li>åˆå¹¶ 00 0001011 0001000 å³åè¿›åˆ¶1416</li>
</ul>

<h2 id="6-å‚è§">6. å‚è§:</h2>
<p>è¡¥ç </p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>-16çš„åŸç æ˜¯110000ã€‚åç æ˜¯101111ï¼ˆè´Ÿæ•°çš„åç ç¬¦å·ä½ä¸å˜ï¼Œæ•°å€¼ä¸º1å˜ä¸º0ï¼Œ0å˜ä¸º1ï¼‰ã€‚è¡¥ç æ˜¯110000ï¼ˆè´Ÿæ•°çš„è¡¥ç ä½åç +1ï¼‰
</code></pre></div></div>
<p><a href="https://blog.csdn.net/weixin_32098487/article/details/117174226">cè¯­è¨€leb128ç¼–ç ,DalVikå­¦ä¹ ä¹‹LEB128æ˜¯ç¥é©¬</a>
<a href="https://blog.csdn.net/new_abc/article/details/36412081">LEB128æ ¼å¼ç®€ä»‹ï¼ˆCNï¼‰</a></p>
:ET